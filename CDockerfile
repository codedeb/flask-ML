ARG BASE_IMAGE=598619258634.dkr.ecr.us-east-1.amazonaws.com/uai3046767-cpl-dev:cisbaseubuntu
FROM $BASE_IMAGE

#ENV HTTPS_PROXY "http://PITC-Zscaler-Americas-Alpharetta3pr.proxy.corporate.ge.com:80"
#ENV HTTP_PROXY "http://PITC-Zscaler-Americas-Alpharetta3pr.proxy.corporate.ge.com:80"

#COPY config/80proxy /etc/apt/apt.conf.d/80proxy

RUN apt-get update -y \
    && apt-get clean \
    && apt-get autoremove

RUN apt-get install -y python3-pip
RUN python3 -m pip install --upgrade pip

# gcc compiler and opencv prerequisites
RUN apt-get -y install git build-essential libglib2.0-0 libsm6 libxext6 libxrender-dev libgl1-mesa-glx

COPY . /gpcloud/ocr-wrapper-service
WORKDIR /gpcloud/ocr-wrapper-service

RUN pip3 install -r /gpcloud/ocr-wrapper-service/requirements.txt

# Detectron2 prerequisites
# RUN pip3 install torch==1.9.0+cu102 torchvision==0.10.0+cu102 --trusted-host=download.pytorch.org -f https://download.pytorch.org/whl/torch_stable.html
RUN pip3 install -U 'git+https://github.com/cocodataset/cocoapi.git#subdirectory=PythonAPI'

# Detectron2 - CPU copy
RUN git clone --depth 1 --branch v0.1 https://github.com/facebookresearch/detectron2.git
RUN pip3 install -U detectron2/.

EXPOSE 5000

ENV REGION=us-east-1 \
    AWS_ACCOUNT_NUMBER=598619258634 \
    BUCKET_NAME=uai3046767-cpl-dev

ENTRYPOINT ["python3", "/gpcloud/ocr-wrapper-service/wsgi.py"]

