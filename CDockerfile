ARG BASE_IMAGE=598619258634.dkr.ecr.us-east-1.amazonaws.com/uai3046767-cpl-dev:cisbaseubuntu
FROM $BASE_IMAGE

#ENV HTTPS_PROXY "http://PITC-Zscaler-Americas-Alpharetta3pr.proxy.corporate.ge.com:80"
#ENV HTTP_PROXY "http://PITC-Zscaler-Americas-Alpharetta3pr.proxy.corporate.ge.com:80"

#COPY config/80proxy /etc/apt/apt.conf.d/80proxy

RUN apt-get update && apt-get install tesseract-ocr -y \
    python3 \
    #python-setuptools \
    python3-pip \
    && apt-get clean \
    && apt-get autoremove

COPY . /ocr-wrapper-service
WORKDIR /ocr-wrapper-service

RUN python3 -m pip install --upgrade pip

# gcc compiler and opencv prerequisites
RUN apt-get -y install nano git build-essential libglib2.0-0 libsm6 libxext6 libxrender-dev libgl1-mesa-glx

RUN pip3 install -r requirements.txt

# Detectron2 prerequisites
RUN pip3 install torch==1.9.0+cu102 torchvision==0.10.0+cu102 --trusted-host=download.pytorch.org -f https://download.pytorch.org/whl/torch_stable.html
RUN pip3 install -U 'git+https://github.com/cocodataset/cocoapi.git#subdirectory=PythonAPI'

# Detectron2 - CPU copy
# RUN python3 -m pip install detectron2==0.5+cpu --trusted-host=dl.fbaipublicfiles.com -f https://dl.fbaipublicfiles.com/detectron2/wheels/cpu/index.html
RUN git clone --depth 1 --branch v0.1 https://github.com/facebookresearch/detectron2.git
RUN ls
RUN pip3 install -U detectron2/.


EXPOSE 5000

ENV AWS_ACCESS_KEY_ID=None \
    AWS_SECRET_ACCESS_KEY=None \
    REGION=us-east-1 \
    INPUT_QUEUE=uai3046767-cpl-dev-idm-input \
    OUTPUT_QUEUE=uai3046767-cpl-dev-idm-output \
    AWS_ACCOUNT_NUMBER=598619258634 \
    BUCKET_NAME=uai3046767-cpl-dev \
    NAS_PATH=/opt/shared/data/cpl/idm

ENTRYPOINT ["python3", "/ocr-wrapper-service/wsgi.py"]s

# $ docker --version
# $ docker build -t sample-cicd:v1 .
# $ docker run -p sample-cicd:v1
