ARG BASE_IMAGE=598619258634.dkr.ecr.us-east-1.amazonaws.com/uai3046767-cpl-dev:cisbaseubuntu
FROM $BASE_IMAGE

RUN apt-get update -y \
    && apt-get clean \
    && apt-get autoremove

RUN apt-get install -y python3-pip
RUN python3 -m pip install --trusted-host pypi.python.org --upgrade pip

# gcc compiler and opencv prerequisites
RUN apt-get -y install git build-essential libglib2.0-0 libsm6 libxext6 libxrender-dev libgl1-mesa-glx

COPY . /ocr-wrapper-service
WORKDIR /ocr-wrapper-service

RUN pip3 install --trusted-host pypi.python.org --trusted-host=download.pytorch.org --no-cache-dir -r /ocr-wrapper-service/requirements.txt

# Detectron2 prerequisites
RUN pip3 install -U 'git+https://github.com/cocodataset/cocoapi.git#subdirectory=PythonAPI'

# Detectron2 - CPU copy
RUN git clone --depth 1 --branch v0.1 https://github.com/facebookresearch/detectron2.git
RUN pip3 install -U detectron2/.

EXPOSE 8090

ENTRYPOINT ["python3", "/ocr-wrapper-service/wsgi.py"]
